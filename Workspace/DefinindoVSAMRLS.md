# Definindo e acessando um banco de dados VSAM RLS

Os KSDSs do VSAM, definidos com o atributo DATABASE(BSON/JSON) e acessados pelo VSAM Record Level Sharing (RLS), juntos fornecem um armazenamento de dados no estilo NoSQL altamente escalonável e altamente disponível no z/OS.

KSDSs definidos com o parâmetro DATABASE, conhecidos como arquivos ou bancos de dados "VSAMDB", permitem o armazenamento de formatos de documentos UTF-8 JavaScript Object Notation (JSON) ou Binary JSON (BSON) e trazem as características não estruturadas dos armazenamentos de dados de nome de chave:valor de chave para o VSAM. Além do acesso RLS, os arquivos VSAMDB herdam todos os recursos de compartilhamento de dados do SYSPLEX atualmente fornecidos a outros aplicativos RLS do VSAM.

Arquivos VSAM padrão contêm registros "semiestruturados", onde campos de chave primária e alternativa têm comprimento e localização fixos dentro do arquivo. Registros VSAM também têm um comprimento máximo de registro de 1 Área de Controle (AC). Arquivos VSAMDB, alternativamente, contêm documentos JSON ou BSON (análogos aos registros VSAM) e podem conter valores de chave primária e AIX, se houver, de comprimentos e localizações variados dentro de cada documento no arquivo. O comprimento dos documentos pode exceder 1 AC até um limite de 2 GIG. Ao fornecer um formato mais desestruturado, a lógica do aplicativo é independente do formato físico do conjunto de dados, permitindo um desenvolvimento mais rápido do aplicativo. Além disso, ao armazenar documentos em formato JSON ou BSON padrão no VSAMDB, os dados podem ser independentes de plataforma, eliminando a necessidade de transformar dados conforme eles se movem pela empresa.

Ao definir o cluster base VSAMDB, além da palavra-chave DATABASE, um nome de chave primária opcional pode ser fornecido por meio do parâmetro KEYNAME/KEYNAMEU. Quando especificado, este parâmetro representa o nome da chave primária dentro do documento, onde um valor exclusivo pode ser encontrado para representar o documento para recuperação direta. KEYNAME especifica o nome da chave primária em caracteres EBCDIC, enquanto KEYNAMEU especifica o nome da chave no formato UTF-8. Em ambos os casos, o nome da chave será armazenado no formato UTF-8 no catálogo.

Se KEYNAME e KEYNAMEU não forem especificados, o VSAM RLS gerará valores de chave implícitos exclusivos para o arquivo específico, que serão retornados ao chamador no RPL MSGAREA após a inserção bem-sucedida. A chave implícita pode ser salva e usada posteriormente para recuperar o documento associado. Um arquivo VSAMDB sem uma chave primária é chamado de "base sem chave". A chave implícita gerada internamente é retornada para a solicitação de atualização PUT bem-sucedida na área apontada pelo RPL MSGAREA.

Com o nome da chave primária explicitamente especificado em DEFINE CLUSTER KEYNAME/KEYNAMEU, ou não especificado (chave implícita), o valor da chave primária de qualquer tamanho de um documento é hash internamente para 128 bytes e concatenado com um número de bloco de 4 bytes para formar uma chave derivada de 132 bytes usada internamente para identificar o documento para as solicitações. Quando uma solicitação retorna o documento, apenas o documento do usuário, sem a chave derivada interna e os metadados, é retornado. Como os valores das chaves são hash, solicitações PUT SEQ para os documentos base não são permitidas, pois as chaves ficam fora de ordem após o hash.

Além das chaves primárias, os documentos VSAMDB podem conter um ou mais nomes de chaves alternativos. As chaves alternativas VSAMDB são especificadas com a palavra-chave ALTKEYS/ALTKEYSU na interface IDCAMS DEFINE ALTERNATEINDEX (AIX). ALTKEYS especifica os nomes de chaves AIX no formato EBCDIC, enquanto ALTKEYSU especifica os nomes de chaves no formato UTF-8. O parâmetro ALTKEYS pode especificar uma lista de nomes de chaves com várias chaves (veja abaixo) e a opção crescente (A) ou decrescente (D). Para cada DEFINE AIX ALTKEYS/ALTKEYSU, o VSAM RLS processa apenas o primeiro nome de chave alternativo na lista e cria e pesquisa os registros AIX com os valores de chave AIX crescentes, como no VSAM padrão. Os aplicativos VSAMDB podem recuperar os nomes de chaves alternativos e os parâmetros A/D do catálogo e usá-los para classificar os documentos retornados pelo VSAM RLS.

Tanto KEYNAME/U quanto ALTKEYS/U podem especificar um nome de chave simples de nível único, um documento incorporado ou um nome de chave de vários níveis, conhecido como nome de chave "multikey". Para BSON, os níveis de chave multikey são concatenados com um "." (notação de ponto), enquanto chaves multikey JSON são concatenadas com um \ (solidus inverso). Uma chave multikey permite que um valor de chave residente em um documento incorporado ou em uma matriz de documentos incorporados seja usado como um valor de chave primário ou alternativo. Por exemplo, ALTKEYS(Name.First,A) e ALTKEYS(Name\First,A) representam um nome de chave multikey de dois níveis, com Name e First, para BSON e JSON, respectivamente; inserir ou atualizar o documento JSON {"Name":{"First":"John"}} resultaria na criação de um registro AIX com "John" como o valor de chave alternativo.

Da mesma forma, para especificar um nome de chave multichave BSON que abranja uma matriz no documento, você pode especificar o nome da chave multichave em KEYNAME ou ALTKEYS como um conjunto completo de níveis de chave ou uma matriz com um índice de matriz. Por exemplo, para um AIX definido com ALTKEYS(Family.Parent.Father) ou ALTKEYS(Family.0.Father,A), quando um documento equivalente a BSON {"Family":["Parent":{"Father":"Dad"},{"Mother":"Mom"}]} é inserido ou atualizado, um registro AIX com o valor de chave "Dad" é criado.

Assim como nas esferas VSAM padrão, os AIXs VSAMDB podem consistir em valores de chave exclusivos ou não exclusivos. No entanto, com os AIXs VSAMDB, não há requisito ou expectativa de que cada documento base contenha o(s) nome(s) de chave alternativo(s) especificado(s), evitando problemas com índices esparsos. Os valores de chave AIX são armazenados em formato claro (sem hash) para permitir acesso sequencial. Apenas os primeiros 251 bytes do valor da chave são usados como chave AIX; valores maiores ainda podem ser usados, mas são truncados em 251 bytes. Portanto, chaves AIX que excedam 251 bytes podem não ser retornadas em ordem crescente ou decrescente e podem precisar de classificação adicional.

Ao contrário do VSAM padrão, um documento base VSAMDB existente pode ser atualizado para que um elemento de nome de chave alternativo:valor de chave seja movido para um local diferente em um documento base ou excluído do documento. Quando o elemento em um documento base é excluído, o registro de índice alternativo associado é atualizado ou excluído de acordo.

O IDCAMS BLDINDEX é necessário para construir um cluster VSAMDB AIX. No entanto, o BLDINDEX pode ser emitido para o VSAMDB independentemente de o documento base estar vazio ou já conter documentos adicionados anteriormente. Além disso, o BLDINDEX pode ser emitido para um cluster base já aberto e atualizado ativamente. O AIX pode então ser acessado pelo nome PATH, como no VSAM padrão.

Os documentos no formato BSON inseridos no VSAMDB devem estar em conformidade com a versão 1.1 do Padrão BSON (consulte BSONspec.org), com todos os campos de comprimento dentro do documento BSON em formato little endian. Documentos JSON devem estar em conformidade com o Padrão JSON de Intercâmbio de Dados (consulte JSON.org). Os documentos BSON ou JSON são passados para o VSAM RLS por meio da RPL AREA em solicitações diretas PUT NUP ou UPDATE. O documento pode residir em um armazenamento de 31 ou 64 bits (RPL OPTCD=ARA64). Para inserções e atualizações JSON, o comprimento do documento deve ser fornecido no RPL RECLEN. Ao posicionar ou executar a recuperação direta de documentos BSON em um arquivo VSAMDB, o argumento RPL deve apontar para o elemento BSON completo que contém o par nome-chave:valor-chave do documento BSON associado. Para recuperações JSON, somente o valor do par nome da chave:valor da chave é necessário para recuperar o documento associado, juntamente com o comprimento do argumento especificado em RPL DBARGLN.

Para acesso sequencial, o RPL pode ser posicionado no primeiro ou último registro (FRD/LRD) e pode ler a base ou o índice associado para frente (padrão) ou para trás (BWD). Requisições PUT SEQ em documentos base VSAMDB não são permitidas porque os valores da chave primária são submetidos a hash e ficam fora de ordem. Consulte [as Instruções de Macro do z/OS DFSMS para Conjuntos de Dados](https://www.ibm.com/docs/en/SSLTBW_2.4.0/com.ibm.zos.v2r4.idad500/abstract.htm) para obter mais informações sobre como codificar as APIs VSAM apropriadas.

Arquivos VSAMDB podem ser acessados com protocolos transacionais quando definidos com os parâmetros LOG(UNDO/ALL) e acessados com o recurso VSAM Transacional do DFSMS. Ao usar o VSAM Transacional, o tamanho do documento é limitado a 64 KB.

O modo LOC não é suportado para documentos VSAMDB.

- **[Exemplo 1 para definir e acessar um banco de dados VSAMDB JSON](https://www.ibm.com/docs/en/SSLTBW_2.4.0/com.ibm.zos.v2r4.idad400/vsamdbjson.htm)**
- **[Exemplo 2 para definir e acessar um banco de dados VSAMDB BSON](https://www.ibm.com/docs/en/SSLTBW_2.4.0/com.ibm.zos.v2r4.idad400/vsamdbbson.htm)**

**Tópico pai:**

[Usando o compartilhamento em nível de registro VSAM](https://www.ibm.com/docs/en/SSLTBW_2.4.0/com.ibm.zos.v2r4.idad400/rls.htm)